<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grammar Games ‚Äì Spiel 2 (Sortieren)</title>

  <link rel="stylesheet" href="shared.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --gg-orange:#FF6B6B;
      --gg-orange-dark:#ff5a5a;
      --gg-surface:rgba(255,255,255,.12);
      --gg-card:rgba(255,255,255,.16);
      --gg-border:rgba(255,255,255,.55);
      --gg-shadow:0 12px 30px rgba(26, 26, 44, .22);
    }
    body{
      font-family:"Poppins", system-ui, Segoe UI, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #b9c6ff33, #0000),
                  radial-gradient(1000px 600px at 90% -10%, #a2b3ff30, #0000),
                  linear-gradient(135deg,#89a6ff 0%, #bba8ff 50%, #d0b7ff 100%);
      min-height:100vh;
    }

    /* ====== Topbar ====== */
    .gg-topbar{
      display:flex; align-items:center; gap:12px;
      padding:14px 18px; position:sticky; top:0; z-index:1050;
      backdrop-filter:saturate(140%) blur(8px);
    }
    .gg-flex-spacer{ flex:1; }
    .gg-btn{
      display:inline-flex; align-items:center; gap:.5rem;
      height:38px; padding:0 14px; border-radius:22px;
      font:600 14px/1.1 "Poppins",system-ui,Segoe UI,Arial,sans-serif;
      text-decoration:none; cursor:pointer; user-select:none;
      transition:.18s ease; border:1.5px solid transparent;
    }
    .gg-primary{ background:var(--gg-orange); color:#fff; border-color:var(--gg-orange); box-shadow:0 6px 18px rgba(255,107,107,.28); }
    .gg-primary:hover{ transform:translateY(-1px); background:var(--gg-orange-dark); }
    .gg-ghost{ background:transparent; color:#fff; border-color:var(--gg-border); }
    .gg-ghost:hover{ background:rgba(255,255,255,.10); }
    .gg-lang.gg-active{ background:var(--gg-orange); color:#fff; border-color:var(--gg-orange); box-shadow:0 6px 18px rgba(255,107,107,.28); }
    .gg-back{ margin-right:8px; }

    /* ====== Page ====== */
    .wrap{ max-width:1200px; margin:0 auto; padding:10px 18px 80px; }
    .page-title{ text-align:center; color:#fff; font-size:40px; font-weight:800; margin:12px 0 6px; letter-spacing:.3px; }
    .page-sub{ text-align:center; color:#fff; opacity:.9; margin:0 0 26px; }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.10));
      border:1px solid rgba(255,255,255,.22);
      border-radius:24px; padding:22px 22px 26px;
      box-shadow: var(--gg-shadow);
    }
    .panel + .panel{ margin-top:20px; }
    .panel-title{
      display:flex; align-items:center; gap:10px; color:#fff; margin:2px 4px 18px;
      font-weight:800; letter-spacing:.2px; font-size:26px;
    }

    /* ====== Floating cards ====== */
    .grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(120px,1fr));
      gap:22px;
    }
    @media (max-width:1000px){
      .grid{ grid-template-columns: repeat(4, minmax(120px,1fr)); }
    }
    @media (max-width:680px){
      .grid{ grid-template-columns: repeat(3, minmax(120px,1fr)); }
    }
    .tile{
      background:#fff; border-radius:22px; height:170px;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      position:relative; cursor:grab; border:4px solid transparent; transition:.18s ease;
    }
    .tile img{ width:88%; height:88%; object-fit:contain; }
    .tile.dragging{ transform:scale(1.07) rotate(2deg); z-index:20; cursor:grabbing; }
    .tile.selected{ border-color:#ffd166; box-shadow:0 16px 30px rgba(255,209,102,.3); }

    /* ====== Sorting rows ====== */
    .rows{ display:flex; flex-direction:column; gap:18px; }
    .row{
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      border-radius:18px; padding:16px 16px 18px;
    }
    .row.locked{ outline:3px solid #46d39a; box-shadow:0 0 0 4px rgba(70,211,154,.18) inset; }

    .row-head{
      display:flex; gap:16px; align-items:center; justify-content:space-between;
      margin-bottom:14px; color:#fff; font-weight:700;
    }
    .tags{ display:flex; gap:8px; flex-wrap:wrap; }
    .tag{ background:#fff; color:#2c2c44; border-radius:999px; padding:6px 10px; font-weight:600; box-shadow:0 4px 10px rgba(0,0,0,.12); }

    .cols{ display:flex; align-items:center; gap:16px; }
    .col{ flex:1; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .label{
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.28);
      color:#fff; font-weight:700; border-radius:12px; height:44px; min-width:170px;
    }
    .equals{ color:#fff; font-size:28px; font-weight:800; padding:0 8px; }

    .slot{
      width:82px; height:82px; border-radius:14px; background:rgba(255,255,255,.12);
      border:2px dashed rgba(255,255,255,.55);
      display:flex; align-items:center; justify-content:center;
      transition:.15s ease; position:relative;
    }
    .row.locked .slot{ border-style:solid; border-color:#46d39a; background:rgba(70,211,154,.12); }
    .slot.hover{ transform:scale(1.04); background:rgba(255,255,255,.24); }
    .slot img{ width:100%; height:100%; object-fit:cover; border-radius:12px; }

    /* ====== Overlay ====== */
    .overlay{
      position:fixed; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; gap:12px;
      background:linear-gradient(135deg,#7489ffcc,#b084ffcc); backdrop-filter:blur(8px); z-index:1200; color:#fff; text-align:center; padding:16px;
    }
    .overlay.show{ display:flex; }
    .overlay h2{ font-size:42px; margin:4px 0; }
    .overlay p{ opacity:.95; margin:0 0 10px; }
    .confetti{ position:absolute; width:10px; height:10px; background:#FFD700; animation: fall 3s linear forwards; }
    @keyframes fall{ to{ transform:translateY(105vh) rotate(720deg); opacity:0; } }
  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="gg-topbar">
    <a class="gg-btn gg-primary gg-back back-link" href="#">‚Üê Zur√ºck</a>

    <div class="gg-flex-spacer"></div>

    <a class="gg-btn gg-ghost gg-lang lang-link" data-lang="de" href="#">Deutsch</a>
    <a class="gg-btn gg-ghost gg-lang lang-link" data-lang="zh" href="#">‰∏≠Êñá</a>

    <button class="gg-btn gg-primary reset-btn" type="button">üîÑ Neues Spiel</button>
  </div>

  <div class="wrap">
    <h1 class="page-title" id="hTitle">Sprach-Sortierspiel</h1>
    <p class="page-sub" id="hSub">Welche Sprachen siehst du? Kannst du das R√§tsel l√∂sen?</p>

    <!-- Floating cards -->
    <section class="panel">
      <div class="panel-title">üìç <span id="allCardsTitle">Alle Karten zum Sortieren</span></div>
      <div class="grid" id="cardsGrid"></div>
    </section>

    <!-- Rows -->
    <section class="panel">
      <div class="panel-title">üéØ <span id="rowsTitle">Sortiere die Karten hier</span></div>

      <div class="rows" id="rows">
        <!-- row template - 3 rows -->
      </div>
    </section>
  </div>

  <!-- Win Overlay -->
  <div class="overlay" id="winOverlay">
    <div style="font-size:64px; line-height:1">üéâ</div>
    <h2 id="winTitle">Gro√üartig!</h2>
    <p id="winText">Du hast alle S√§tze korrekt gebaut.</p>
    <a class="gg-btn gg-primary back-link" id="backPreview" href="#">‚Üê Zur√ºck zur √úbersicht</a>
  </div>

  <script src="language.js"></script>
  <script src="analytics.js"></script>

  <script>
    /******** URL / Lang / Variant ********/
    const qs = new URLSearchParams(location.search);
    const VARIANT = (qs.get('variant') || 'A').toUpperCase();
    const LANG    = (qs.get('lang') || localStorage.getItem('grammarGamesLanguage') || 'de').toLowerCase();

    const i18n = {
      de:{
        title:"Sprach-Sortierspiel",
        sub:"Welche Sprachen siehst du? Kannst du das R√§tsel l√∂sen?",
        all:"Alle Karten zum Sortieren",
        rows:"Sortiere die Karten hier",
        de:"Deutsch", enLabel:"English",
        winTitle:"Gro√üartig!",
        winText:"Du hast alle S√§tze korrekt gebaut.",
        back:"‚Üê Zur√ºck",
        reset:"Neues Spiel",
        backPreview:"‚Üê Zur√ºck zur √úbersicht"
      },
      zh:{
        title:"ËØ≠Ë®ÄÂàÜÁ±ªÊ∏∏Êàè",
        sub:"‰Ω†ÁúãÂà∞‰∫ÜÂì™‰∫õËØ≠Ë®ÄÔºü‰Ω†ËÉΩÂÆåÊàêÊãºÂõæÂêóÔºü",
        all:"ÊâÄÊúâÂç°ÁâáÂæÖÂàÜÁ±ª",
        rows:"Âú®Ê≠§ÂàÜÁ±ªÂç°Áâá",
        de:"Âæ∑ËØ≠", enLabel:"Ëã±ËØ≠",
        winTitle:"Â§™Ê£í‰∫ÜÔºÅ",
        winText:"‰Ω†ÊääÊâÄÊúâÂè•Â≠êÈÉΩÊ≠£Á°ÆÂÆåÊàê‰∫Ü„ÄÇ",
        back:"‚Üê ËøîÂõû",
        reset:"Êñ∞Ê∏∏Êàè",
        backPreview:"‚Üê ËøîÂõûÊ¶ÇËßà"
      }
    };

    function t(k){ return (i18n[LANG]||i18n.de)[k]; }
    function applyTexts(){
      document.getElementById('hTitle').textContent = t('title');
      document.getElementById('hSub').textContent   = t('sub');
      document.getElementById('allCardsTitle').textContent = t('all');
      document.getElementById('rowsTitle').textContent     = t('rows');
      document.getElementById('winTitle').textContent      = t('winTitle');
      document.getElementById('winText').textContent       = t('winText');
      document.querySelector('.reset-btn').innerHTML       = "üîÑ " + t('reset');
      document.querySelector('.lang-link[data-lang="de"]').textContent = t('de');
      document.querySelector('.lang-link[data-lang="zh"]').textContent = "‰∏≠Êñá";
      document.getElementById('backPreview').textContent   = t('backPreview');
      document.querySelector('.back-link').textContent     = t('back');
    }

    /* Back + Language links keep params */
    (function navInit(){
      const back = document.querySelectorAll('.back-link');
      back.forEach(a=>{
        const u = new URL('preview.html', location.href);
        u.searchParams.set('variant', VARIANT);
        u.searchParams.set('lang', LANG);
        a.href = u.pathname + '?' + u.searchParams.toString();
      });

      document.querySelectorAll('.lang-link').forEach(a=>{
        const L = a.dataset.lang;
        const url = new URL(location.href);
        url.searchParams.set('lang', L);
        url.searchParams.set('variant', VARIANT);
        a.href = url.pathname + '?' + url.searchParams.toString();
        a.classList.toggle('gg-active', L === LANG);
      });

      document.querySelector('.reset-btn').addEventListener('click', resetGame);
    })();

    /******** Deck ********/
    const DECK = [
      { id:"I",            file:"german_I.png",           side:"en" },
      { id:"ich",          file:"german_ich.png",         side:"de" },
      { id:"you",          file:"german_you.png",         side:"en" },
      { id:"du",           file:"german_du.png",          side:"de" },
      { id:"he_she_it",    file:"german_he_she_it.png",   side:"en" },
      { id:"er_sie_es",    file:"german_er_sie_es.png",   side:"de" },
      { id:"am",           file:"german_am.png",          side:"en" },
      { id:"bin",          file:"german_bin.png",         side:"de" },
      { id:"are",          file:"german_are.png",         side:"en" },
      { id:"bist",         file:"german_bist.png",        side:"de" },
      { id:"is",           file:"german_is.png",          side:"en" },
      { id:"ist",          file:"german_ist.png",         side:"de" }
    ];

    /* Target pairs: row can be any of these */
    const TARGETS = [
      { name:"you-are ‚Üî du-bist",  de:new Set(["du","bist"]),         en:new Set(["you","are"]) },
      { name:"I-am ‚Üî ich-bin",     de:new Set(["ich","bin"]),         en:new Set(["I","am"]) },
      { name:"he/she/it-is ‚Üî er/sie/es-ist", de:new Set(["er_sie_es","ist"]), en:new Set(["he_she_it","is"]) }
    ];

    const grid = document.getElementById('cardsGrid');
    const rowsEl = document.getElementById('rows');
    const winOverlay = document.getElementById('winOverlay');

    const placed = new Map();     // cardId -> {row, slotEl}
    const rowState = [1,2,3].map(()=>({ de:new Set(), en:new Set(), locked:false }));

    let selectedCardId = null;

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    function makeCard(card){
      const div = document.createElement('div');
      div.className = 'tile';
      div.draggable = true;
      div.dataset.id = card.id;
      div.dataset.side = card.side;
      div.innerHTML = `<img src="cards/${card.file}" alt="${card.id}">`;

      // drag
      div.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', card.id);
        div.classList.add('dragging');
      });
      div.addEventListener('dragend', ()=> div.classList.remove('dragging'));

      // click select
      div.addEventListener('click', ()=>{
        if (selectedCardId === card.id){
          selectedCardId = null;
          div.classList.remove('selected');
          return;
        }
        document.querySelectorAll('.tile.selected').forEach(x=> x.classList.remove('selected'));
        selectedCardId = card.id;
        div.classList.add('selected');
      });

      return div;
    }

    function renderCards(){
      grid.innerHTML = '';
      shuffle([...DECK]).forEach(c=> grid.appendChild(makeCard(c)));
    }

    function buildRows(){
      rowsEl.innerHTML = '';
      for (let i=0;i<3;i++){
        const idx = i; // row index
        const row = document.createElement('div');
        row.className = 'row';
        row.dataset.index = idx;

        const head = document.createElement('div');
        head.className = 'row-head';
        head.innerHTML = `
          <div class="tags">
            <span class="tag">Row ${idx+1}</span>
            <span class="tag" style="opacity:.7">Beliebige der 3 Ziel-S√§tze</span>
          </div>
        `;

        const cols = document.createElement('div');
        cols.className = 'cols';
        const colLeft = document.createElement('div');
        colLeft.className = 'col';
        const colRight = document.createElement('div');
        colRight.className = 'col';

        const labelDe = document.createElement('div');
        labelDe.className = 'label';
        labelDe.textContent = t('de');
        const labelEn = document.createElement('div');
        labelEn.className = 'label';
        labelEn.textContent = t('enLabel');

        colLeft.appendChild(labelDe);
        colRight.appendChild(labelEn);

        // 2 de slots
        for (let s=0;s<2;s++){
          colLeft.appendChild(makeSlot(idx, 'de'));
        }
        // equals
        const eq = document.createElement('div');
        eq.className = 'equals'; eq.textContent = '=';
        // 2 en slots
        for (let s=0;s<2;s++){
          colRight.appendChild(makeSlot(idx, 'en'));
        }

        cols.appendChild(colLeft);
        cols.appendChild(eq);
        cols.appendChild(colRight);
        row.appendChild(head);
        row.appendChild(cols);
        rowsEl.appendChild(row);
      }
    }

    function makeSlot(rowIndex, side){
      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.dataset.row = rowIndex;
      slot.dataset.side = side;

      // DnD
      slot.addEventListener('dragover', e=>{ e.preventDefault(); if(!rowState[rowIndex].locked && !slot.firstChild) slot.classList.add('hover'); });
      slot.addEventListener('dragleave', ()=> slot.classList.remove('hover'));
      slot.addEventListener('drop', e=>{
        e.preventDefault();
        slot.classList.remove('hover');
        const id = e.dataTransfer.getData('text/plain');
        placeIntoSlot(id, slot);
      });

      // Click target for selected card
      slot.addEventListener('click', ()=>{
        if (slot.firstChild){
          // remove existing -> back to pool
          const img = slot.firstChild;
          const id = img.dataset.id;
          removeFromSlot(id, slot);
          return;
        }
        if (selectedCardId){ placeIntoSlot(selectedCardId, slot); }
      });

      return slot;
    }

    function getCardMeta(id){ return DECK.find(c=> c.id===id); }

    function placeIntoSlot(cardId, slot){
      const meta = getCardMeta(cardId);
      if (!meta) return;
      const rowIdx = Number(slot.dataset.row);
      const side = slot.dataset.side;

      if (rowState[rowIdx].locked) return;
      if (slot.firstChild) return; // already filled
      if (meta.side !== side) return; // must fit side (de/en)

      // If card was placed elsewhere, remove there first
      if (placed.has(cardId)){
        const prev = placed.get(cardId);
        if (prev && prev.slotEl && prev.slotEl.firstChild){
          prev.slotEl.firstChild.remove();
          updateRowSets(prev.row, getCardMeta(cardId), 'remove');
        }
      }

      // create preview in slot
      const img = document.createElement('img');
      img.src = `cards/${meta.file}`;
      img.alt = cardId;
      img.dataset.id = cardId;
      slot.appendChild(img);

      placed.set(cardId, {row: rowIdx, slotEl: slot});
      updateRowSets(rowIdx, meta, 'add');

      // hide source tile & unselect
      const tile = grid.querySelector(`.tile[data-id="${cardId}"]`);
      if (tile){ tile.style.visibility = 'hidden'; tile.classList.remove('selected'); }
      if (selectedCardId === cardId) selectedCardId = null;

      // Check row
      maybeValidateRow(rowIdx);
    }

    function removeFromSlot(cardId, slot){
      const meta = getCardMeta(cardId);
      if (!meta) return;
      const rowIdx = Number(slot.dataset.row);
      if (rowState[rowIdx].locked) return;

      // remove visual
      if (slot.firstChild) slot.firstChild.remove();

      // unhide tile
      const tile = grid.querySelector(`.tile[data-id="${cardId}"]`);
      if (tile){ tile.style.visibility = 'visible'; }

      placed.delete(cardId);
      updateRowSets(rowIdx, meta, 'remove');
    }

    function updateRowSets(rowIdx, meta, op){
      const set = rowState[rowIdx][meta.side]; // de or en
      if (op==='add') set.add(meta.id);
      else if (op==='remove') set.delete(meta.id);
    }

    function setEquals(aSet, bSet){
      if (aSet.size !== bSet.size) return false;
      for (const x of aSet) if (!bSet.has(x)) return false;
      return true;
    }

    function findMatchingTarget(rowIdx){
      const deSet = rowState[rowIdx].de;
      const enSet = rowState[rowIdx].en;
      for (const t of TARGETS){
        if (setEquals(deSet, t.de) && setEquals(enSet, t.en)) return t;
      }
      return null;
    }

    function shakeRow(rowIdx){
      const row = rowsEl.querySelector(`.row[data-index="${rowIdx}"]`);
      row.style.transform = 'translateX(-3px)';
      setTimeout(()=> row.style.transform = '', 120);
    }

    function clearRow(rowIdx){
      // return all cards to pool
      const row = rowsEl.querySelector(`.row[data-index="${rowIdx}"]`);
      row.querySelectorAll('.slot').forEach(slot=>{
        if (slot.firstChild){
          const id = slot.firstChild.dataset.id;
          removeFromSlot(id, slot);
        }
      });
    }

    function lockRow(rowIdx){
      rowState[rowIdx].locked = true;
      const row = rowsEl.querySelector(`.row[data-index="${rowIdx}"]`);
      row.classList.add('locked');
      row.querySelectorAll('.slot').forEach(s=> s.classList.remove('hover'));
    }

    function maybeValidateRow(rowIdx){
      // must be 2 de + 2 en
      const st = rowState[rowIdx];
      if (st.de.size < 2 || st.en.size < 2) return;

      const target = findMatchingTarget(rowIdx);
      if (!target){
        // wrong ‚Äì return cards to pool
        shakeRow(rowIdx);
        setTimeout(()=> clearRow(rowIdx), 160);
        return;
      }

      // correct
      lockRow(rowIdx);

      tryTrack('game2_row', {row: rowIdx+1, target: target.name});

      // Win if all three locked
      if (rowState.every(r=> r.locked)){
        setTimeout(showWin, 200);
      }
    }

    function showWin(){
      winOverlay.classList.add('show');
      for (let i=0;i<60;i++){
        setTimeout(()=> {
          const c = document.createElement('div');
          c.className='confetti';
          c.style.left = (Math.random()*100)+'%';
          c.style.top  = '-20px';
          c.style.background = ['#FFD700','#FF6B6B','#4ECDC4','#45B7D1','#96CEB4'][Math.floor(Math.random()*5)];
          c.style.animationDelay = (Math.random()*1.2)+'s';
          document.getElementById('winOverlay').appendChild(c);
          setTimeout(()=> c.remove(), 3200);
        }, i*35);
      }
      tryTrack('game2_complete');
    }

    function resetGame(){
      // clear state
      placed.clear();
      for (let i=0;i<3;i++){ rowState[i].de.clear(); rowState[i].en.clear(); rowState[i].locked=false; }
      winOverlay.classList.remove('show');

      // restore tiles
      renderCards();
      // rebuild rows to reset locks/slots
      buildRows();

      tryTrack('game2_start');
    }

    function tryTrack(evt, payload={}){
      try{
        (window.analytics && window.analytics.trackClick)
          ? window.analytics.trackClick(evt, payload)
          : (window.analytics?.track?.(evt, payload));
      }catch(_){}
    }

    /* ------- INIT ------- */
    applyTexts();
    renderCards();
    buildRows();
    tryTrack('game2_start');

    /* ========= NEW: Auto-scroll while dragging (no other changes) ========= */
    (function enableAutoScrollOnDrag(){
      const EDGE = 100;      // px from top/bottom to trigger
      const STEP = 28;       // scroll step in px per event
      let raf = null;

      function onDragOver(e){
        // e.clientY is available for mouse drag events
        const y = e.clientY;
        if (typeof y !== 'number') return;

        const vh = window.innerHeight;
        if (y < EDGE){
          scheduleScroll(-STEP);
        } else if (vh - y < EDGE){
          scheduleScroll(STEP);
        }
      }

      function scheduleScroll(delta){
        if (raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(()=> {
          window.scrollBy(0, delta);
          raf = null;
        });
      }

      // Scroll when dragging anywhere on the page
      window.addEventListener('dragover', onDragOver, { passive: true });
    })();
    /* ========= END auto-scroll ========= */
  </script>
</body>
</html>
