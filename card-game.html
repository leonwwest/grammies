<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grammar Games ‚Äì Spiel 1 (Paare)</title>

  <link rel="stylesheet" href="shared.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --gg-orange:#FF6B6B;
      --gg-orange-dark:#ff5a5a;
      --gg-surface:rgba(255,255,255,.12);
      --gg-card:rgba(255,255,255,.16);
      --gg-border:rgba(255,255,255,.55);
      --gg-shadow:0 12px 30px rgba(26, 26, 44, .22);
    }
    body{
      font-family:"Poppins", system-ui, Segoe UI, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #b9c6ff33, #0000),
                  radial-gradient(1000px 600px at 90% -10%, #a2b3ff30, #0000),
                  linear-gradient(135deg,#89a6ff 0%, #bba8ff 50%, #d0b7ff 100%);
      min-height:100vh;
    }

    /* ===== Topbar ===== */
    .gg-topbar{
      display:flex; align-items:center; gap:12px;
      padding:14px 18px; position:sticky; top:0; z-index:1050;
      backdrop-filter:saturate(140%) blur(8px);
    }
    .gg-flex-spacer{ flex:1; }
    .gg-btn{
      display:inline-flex; align-items:center; gap:.5rem;
      height:38px; padding:0 14px; border-radius:22px;
      font:600 14px/1.1 "Poppins",system-ui,Segoe UI,Arial,sans-serif;
      text-decoration:none; cursor:pointer; user-select:none;
      transition:.18s ease; border:1.5px solid transparent;
    }
    .gg-primary{ background:var(--gg-orange); color:#fff; border-color:var(--gg-orange); box-shadow:0 6px 18px rgba(255,107,107,.28); }
    .gg-primary:hover{ transform:translateY(-1px); background:var(--gg-orange-dark); }
    .gg-ghost{ background:transparent; color:#fff; border-color:var(--gg-border); }
    .gg-ghost:hover{ background:rgba(255,255,255,.10); }
    .gg-lang.gg-active{ background:var(--gg-orange); color:#fff; border-color:var(--gg-orange); box-shadow:0 6px 18px rgba(255,107,107,.28); }
    .gg-back{ margin-right:8px; }

    /* ===== Page ===== */
    .wrap{ max-width:1200px; margin:0 auto; padding:10px 18px 90px; }
    .page-title{ text-align:center; color:#fff; font-size:40px; font-weight:800; margin:12px 0 6px; letter-spacing:.3px; }
    .page-sub{ text-align:center; color:#fff; opacity:.9; margin:0 0 26px; }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.10));
      border:1px solid rgba(255,255,255,.22);
      border-radius:24px; padding:22px 22px 26px;
      box-shadow: var(--gg-shadow);
    }
    .panel + .panel{ margin-top:20px; }
    .panel-title{
      display:flex; align-items:center; gap:10px; color:#fff; margin:2px 4px 18px;
      font-weight:800; letter-spacing:.2px; font-size:26px;
    }

    /* ===== Cards grid ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(120px,1fr));
      gap:22px;
    }
    @media (max-width:1000px){
      .grid{ grid-template-columns: repeat(4, minmax(120px,1fr)); }
    }
    @media (max-width:680px){
      .grid{ grid-template-columns: repeat(3, minmax(100px,1fr)); }
      .tile{ height:150px; }
    }
    .tile{
      background:#fff; border-radius:22px; height:170px;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      position:relative; cursor:grab; border:4px solid transparent; transition:.18s ease;
      touch-action: none; /* enable smooth touch dragging without page scroll */
    }
    .tile img{ width:88%; height:88%; object-fit:contain; }
    .tile.dragging{ transform:scale(1.07) rotate(2deg); z-index:20; cursor:grabbing; }
    .tile.selected{ border-color:#ffd166; box-shadow:0 16px 30px rgba(255,209,102,.3); }
    .tile.hidden{ visibility:hidden; }

    /* ===== Hits (matched pairs) ===== */
    .hits-wrap{ display:flex; flex-direction:column; gap:10px; }
    .hits-empty{ color:#fff; opacity:.85; margin:2px 6px 12px; }
    .hits{
      display:flex; flex-wrap:wrap; gap:14px;
      min-height:42px;
    }
    .hit{
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.28);
      padding:8px; border-radius:16px; color:#fff;
      box-shadow:0 6px 16px rgba(0,0,0,.12);
    }
    .hit .mini{ width:58px; height:58px; border-radius:12px; background:#fff; display:flex; align-items:center; justify-content:center; }
    .hit .mini img{ width:90%; height:90%; object-fit:contain; }
    .hit .ok{ font-weight:800; }

    .cta-row{ display:flex; justify-content:center; padding-top:10px; }
    .hidden{ display:none !important; }

    /* ===== Overlay (win) ===== */
    .overlay{
      position:fixed; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; gap:16px;
      background:linear-gradient(135deg,#7489ffcc,#b084ffcc); backdrop-filter:blur(8px); z-index:1200; color:#fff; text-align:center; padding:16px;
    }
    .overlay.show{ display:flex; }
    .overlay h2{ font-size:42px; margin:4px 0; }
    .overlay p{ opacity:.95; margin:0 0 10px; }
    .overlay .btn-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }

    .confetti{ position:absolute; width:10px; height:10px; background:#FFD700; animation: fall 3s linear forwards; }
    @keyframes fall{ to{ transform:translateY(105vh) rotate(720deg); opacity:0; } }
  </style>
</head>
<body>

  <!-- Topbar (orange) -->
  <div class="gg-topbar">
    <a class="gg-btn gg-primary gg-back back-link" href="#">‚Üê Zur√ºck</a>

    <div class="gg-flex-spacer"></div>

    <a class="gg-btn gg-ghost gg-lang lang-link" data-lang="de" href="#">Deutsch</a>
    <a class="gg-btn gg-ghost gg-lang lang-link" data-lang="zh" href="#">‰∏≠Êñá</a>

    <button class="gg-btn gg-primary reset-btn" type="button">üîÑ Neues Spiel</button>
  </div>

  <div class="wrap">
    <h1 class="page-title" id="hTitle">Ordne die Karten in 6 Paare</h1>
    <p class="page-sub" id="hSub">
      Ziehe zusammengeh√∂rige Karten aufeinander (z. B. <em>I</em> ‚Üî <em>ich</em>). Richtig verbundene Paare verschwinden und erscheinen unten als Treffer.
    </p>

    <!-- Alle Karten -->
    <section class="panel">
      <div class="panel-title">üß© <span id="allCardsTitle">Alle Karten</span></div>
      <div class="grid" id="cardsGrid"></div>
    </section>

    <!-- Korrekte Paare (mit Bildern) -->
    <section class="panel">
      <div class="panel-title">‚úÖ <span id="hitsTitle">Korrekte Paare</span></div>

      <div class="hits-wrap">
        <div class="hits-empty" id="hitsEmpty">Noch keine Treffer ‚Äì leg los! üòä</div>
        <div class="hits" id="hits"></div>

        <div class="cta-row">
          <a class="gg-btn gg-primary hidden" id="toGame2" href="#">‚ñ∂ Weiter zu Spiel 2</a>
        </div>
      </div>
    </section>
  </div>

  <!-- Gl√ºckwunsch-Overlay -->
  <div class="overlay" id="winOverlay">
    <div style="font-size:64px; line-height:1">üéâ</div>
    <h2 id="winTitle">Super gemacht!</h2>
    <p id="winText">Du hast alle 6 Paare gefunden.</p>
    <div class="btn-row">
      <a class="gg-btn gg-primary" id="toGame2Overlay" href="#">‚ñ∂ Weiter zu Spiel 2</a>
      <a class="gg-btn gg-primary back-link" id="backPreview" href="#">‚Üê Zur√ºck zur √úbersicht</a>
    </div>
  </div>

  <script src="language.js"></script>
  <script src="analytics.js"></script>
  <script>
    /******** URL / Lang / Variant ********/
    const qs = new URLSearchParams(location.search);
    const VARIANT = (qs.get('variant') || 'A').toUpperCase();
    const LANG    = (qs.get('lang') || localStorage.getItem('grammarGamesLanguage') || 'de').toLowerCase();

    const i18n = {
      de:{
        title:"Ordne die Karten in 6 Paare",
        sub:"Ziehe zusammengeh√∂rige Karten aufeinander (z. B. I ‚Üî ich). Richtig verbundene Paare verschwinden und erscheinen unten als Treffer.",
        all:"Alle Karten",
        hits:"Korrekte Paare",
        empty:"Noch keine Treffer ‚Äì leg los! üòä",
        winTitle:"Super gemacht!",
        winText:"Du hast alle 6 Paare gefunden.",
        back:"‚Üê Zur√ºck",
        reset:"Neues Spiel",
        backPreview:"‚Üê Zur√ºck zur √úbersicht",
        toGame2:"‚ñ∂ Weiter zu Spiel 2"
      },
      zh:{
        title:"ÊääÂç°ÁâáÈÖçÊàê 6 ÂØπ",
        sub:"ÊääÂØπÂ∫îÁöÑÂç°ÁâáÊãñÂà∞‰∏ÄËµ∑Ôºà‰æãÂ¶Ç I ‚Üî ÊàëÔºâ„ÄÇÊ≠£Á°ÆÈÖçÂØπ‰ºöÊ∂àÂ§±ÔºåÂπ∂Âú®‰∏ãÊñπÊòæÁ§∫‰∏∫ÂëΩ‰∏≠„ÄÇ",
        all:"ÂÖ®ÈÉ®Âç°Áâá",
        hits:"Ê≠£Á°ÆÈÖçÂØπ",
        empty:"ËøòÊ≤°ÊúâÂëΩ‰∏≠ÔºåÂä†Ê≤πÔºÅüòä",
        winTitle:"Â§™Ê£í‰∫ÜÔºÅ",
        winText:"‰Ω†ÊâæÂà∞‰∫ÜÂÖ®ÈÉ® 6 ÂØπ„ÄÇ",
        back:"‚Üê ËøîÂõû",
        reset:"Êñ∞Ê∏∏Êàè",
        backPreview:"‚Üê ËøîÂõûÊ¶ÇËßà",
        toGame2:"‚ñ∂ ÁªßÁª≠Âà∞Ê∏∏Êàè 2"
      }
    };
    function t(k){ return (i18n[LANG]||i18n.de)[k]; }
    function applyTexts(){
      document.getElementById('hTitle').textContent = t('title');
      document.getElementById('hSub').textContent   = t('sub');
      document.getElementById('allCardsTitle').textContent = t('all');
      document.getElementById('hitsTitle').textContent     = t('hits');
      document.getElementById('hitsEmpty').textContent     = t('empty');
      document.getElementById('winTitle').textContent      = t('winTitle');
      document.getElementById('winText').textContent       = t('winText');
      document.getElementById('toGame2').textContent       = t('toGame2');
      document.getElementById('toGame2Overlay').textContent= t('toGame2');
      document.querySelector('.reset-btn').innerHTML       = "üîÑ " + t('reset');
      document.querySelector('.lang-link[data-lang="de"]').textContent = "Deutsch";
      document.querySelector('.lang-link[data-lang="zh"]').textContent = "‰∏≠Êñá";
      document.querySelectorAll('.back-link').forEach(a=> a.textContent = t('back'));
      document.getElementById('backPreview').textContent = t('backPreview');
    }

    /* Back + Language + Game2 links keep params */
    (function navInit(){
      const back = document.querySelectorAll('.back-link');
      back.forEach(a=>{
        const u = new URL('preview.html', location.href);
        u.searchParams.set('variant', VARIANT);
        u.searchParams.set('lang', LANG);
        a.href = u.pathname + '?' + u.searchParams.toString();
      });

      document.querySelectorAll('.lang-link').forEach(a=>{
        const L = a.dataset.lang;
        const url = new URL(location.href);
        url.searchParams.set('lang', L);
        url.searchParams.set('variant', VARIANT);
        a.href = url.pathname + '?' + url.searchParams.toString();
        a.classList.toggle('gg-active', L === LANG);
      });

      const go2 = new URL('sorting-game.html', location.href);
      go2.searchParams.set('variant', VARIANT);
      go2.searchParams.set('lang', LANG);
      document.getElementById('toGame2').href        =
      document.getElementById('toGame2Overlay').href = go2.pathname + '?' + go2.searchParams.toString();

      document.querySelector('.reset-btn').addEventListener('click', resetGame);
    })();

    /******** Karten & Paare ********/
    // 6 Paare: 3 Pronomen, 3 Formen von "to be"
    const DECK_DE = [
      { id:"I",          pair:"I-ich",               file:"german_I.png" },
      { id:"ich",        pair:"I-ich",               file:"german_ich.png" },
      { id:"you",        pair:"you-du",              file:"german_you.png" },
      { id:"du",         pair:"you-du",              file:"german_du.png" },
      { id:"he_she_it",  pair:"he/she/it-er/sie/es", file:"german_he_she_it.png" },
      { id:"er_sie_es",  pair:"he/she/it-er/sie/es", file:"german_er_sie_es.png" },

      { id:"am",         pair:"am-bin",              file:"german_am.png" },
      { id:"bin",        pair:"am-bin",              file:"german_bin.png" },
      { id:"are",        pair:"are-bist",            file:"german_are.png" },
      { id:"bist",       pair:"are-bist",            file:"german_bist.png" },
      { id:"is",         pair:"is-ist",              file:"german_is.png" },
      { id:"ist",        pair:"is-ist",              file:"german_ist.png" }
    ];

    const DECK_ZH = [
      { id:"I",          pair:"I-wo",                 file:"mandarin_I.png" },
      { id:"wo",         pair:"I-wo",                 file:"mandarin_wo.png" },
      { id:"you",        pair:"you-ni",               file:"mandarin_you.png" },
      { id:"ni",         pair:"you-ni",               file:"mandarin_ni.png" },
      { id:"he_she_it",  pair:"he/she/it-ta/ta/ta",   file:"mandarin_he_she_it.png" },
      { id:"ta_ta_ta",   pair:"he/she/it-ta/ta/ta",   file:"mandarin_ta_ta_ta.png" },

      { id:"am",         pair:"am-wo_shi",            file:"mandarin_am.png" },
      { id:"wo_shi",     pair:"am-wo_shi",            file:"mandarin_wo_shi.png" },
      { id:"are",        pair:"are-ni_shi",           file:"mandarin_are.png" },
      { id:"ni_shi",     pair:"are-ni_shi",           file:"mandarin_ni_shi.png" },
      { id:"is",         pair:"is-ta_shi",            file:"mandarin_is.png" },
      { id:"ta_shi",     pair:"is-ta_shi",            file:"mandarin_ta_shi.png" }
    ];

    const DECK = (LANG === 'zh') ? DECK_ZH : DECK_DE;

    const grid = document.getElementById('cardsGrid');
    const hitsBox = document.getElementById('hits');
    const hitsEmpty = document.getElementById('hitsEmpty');
    const toGame2Btn = document.getElementById('toGame2');
    const winOverlay = document.getElementById('winOverlay');

    let firstPick = null;
    let matchedPairs = 0;

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    function makeTile(card){
      const div = document.createElement('div');
      div.className = 'tile';
      div.draggable = true;
      div.dataset.id = card.id;
      div.dataset.pair = card.pair;
      div.innerHTML = `<img src="cards/${card.file}" alt="${card.id}">`;

      // drag
      div.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', JSON.stringify({id:card.id, pair:card.pair}));
        div.classList.add('dragging');
      });
      div.addEventListener('dragend', ()=> div.classList.remove('dragging'));

      // allow drop ON other tiles
      div.addEventListener('dragover', e=> e.preventDefault());
      div.addEventListener('drop', e=>{
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        tryMatch(data, {id:card.id, pair:card.pair}, div);
      });

      // click to select / match
      div.addEventListener('click', ()=>{
        if (!firstPick){
          firstPick = div;
          div.classList.add('selected');
        }else if(firstPick === div){
          firstPick.classList.remove('selected');
          firstPick = null;
        }else{
          tryMatch(
            {id:firstPick.dataset.id, pair:firstPick.dataset.pair},
            {id:div.dataset.id,       pair:div.dataset.pair},
            div
          );
        }
      });

      // Pointer-based drag for touch devices (mobile-friendly)
      div.addEventListener('pointerdown', (e)=>{
        div.classList.add('dragging');
        try{ div.setPointerCapture(e.pointerId); }catch(_){ }
        div.__dragMeta = { id: card.id, pair: card.pair };
      });
      div.addEventListener('pointerup', (e)=>{
        div.classList.remove('dragging');
        const meta = div.__dragMeta; delete div.__dragMeta;
        if (!meta) return;
        // Temporarily hide source to hit-test element underneath
        const prevVis = div.style.visibility;
        div.style.visibility = 'hidden';
        const el = document.elementFromPoint(e.clientX, e.clientY);
        div.style.visibility = prevVis;
        const target = el && el.closest ? el.closest('.tile') : null;
        if (target && target !== div){
          tryMatch(
            { id: meta.id, pair: meta.pair },
            { id: target.dataset.id, pair: target.dataset.pair },
            target
          );
        }
      });
      div.addEventListener('pointercancel', ()=>{ div.classList.remove('dragging'); div.__dragMeta = null; });

      return div;
    }

    function renderGrid(){
      grid.innerHTML = '';
      shuffle([...DECK]).forEach(c=> grid.appendChild(makeTile(c)));
    }

    function tryMatch(a, b, targetTile){
      if (!a || !b) return;

      const t1 = grid.querySelector(`.tile[data-id="${a.id}"]`);
      const t2 = grid.querySelector(`.tile[data-id="${b.id}"]`);

      const sameCard = a.id === b.id;
      const correct = a.pair === b.pair && !sameCard;

      if (firstPick) firstPick.classList.remove('selected');
      firstPick = null;

      if (!correct){
        // tiny shake for feedback
        if (targetTile){
          targetTile.style.transform = 'translateX(-3px)';
          setTimeout(()=> targetTile.style.transform='', 120);
        }
        return;
      }

      // Correct pair ‚Üí hide tiles, add to hits list
      if (t1) t1.classList.add('hidden');
      if (t2) t2.classList.add('hidden');

      addHitPair(a.id, b.id, a.pair);
      matchedPairs++;

      tryTrack('game1_pair', { pair: a.pair });

      // Win after 6 pairs
      if (matchedPairs === 6){
        toGame2Btn.classList.remove('hidden');
        setTimeout(showWin, 350);
      }
    }

    function cardFile(id){
      const c = DECK.find(x=> x.id === id);
      return c ? c.file : '';
    }

    function addHitPair(id1, id2, pairName){
      hitsEmpty.classList.add('hidden');

      // keep a consistent left-right order by file name
      const files = [cardFile(id1), cardFile(id2)];
      files.sort();

      const hit = document.createElement('div');
      hit.className = 'hit';
      hit.innerHTML = `
        <span class="ok">‚úî</span>
        <span class="mini"><img src="cards/${files[0]}" alt=""></span>
        <span class="mini"><img src="cards/${files[1]}" alt=""></span>
      `;
      hitsBox.appendChild(hit);
    }

    function showWin(){
      winOverlay.classList.add('show');
      for (let i=0;i<60;i++){
        setTimeout(()=> {
          const c = document.createElement('div');
          c.className='confetti';
          c.style.left = (Math.random()*100)+'%';
          c.style.top  = '-20px';
          c.style.background = ['#FFD700','#FF6B6B','#4ECDC4','#45B7D1','#96CEB4'][Math.floor(Math.random()*5)];
          c.style.animationDelay = (Math.random()*1.2)+'s';
          document.getElementById('winOverlay').appendChild(c);
          setTimeout(()=> c.remove(), 3200);
        }, i*35);
      }
      tryTrack('game1_complete');
    }

    function resetGame(){
      matchedPairs = 0;
      firstPick = null;
      hitsBox.innerHTML = '';
      hitsEmpty.classList.remove('hidden');
      document.getElementById('toGame2').classList.add('hidden');
      winOverlay.classList.remove('show');
      renderGrid();
      tryTrack('game1_start');
    }

    function tryTrack(evt, payload={}){
      try{
        (window.analytics && window.analytics.trackClick)
          ? window.analytics.trackClick(evt, payload)
          : (window.analytics?.track?.(evt, payload));
      }catch(_){}
    }

    /* Init */
    applyTexts();
    renderGrid();
    tryTrack('game1_start');

    // reset button
    document.querySelector('.reset-btn').addEventListener('click', resetGame);
  </script>
</body>
</html>
